<script>
  // Function to display test results in the required format
  function displayTestResults(testResults) {
    const testResultsList = document.getElementById('testResultsList');
    const testResultsLoading = document.getElementById('testResultsLoading');
    testResultsList.innerHTML = ''; // Clear existing content
    testResultsLoading.style.display = 'none'; // Hide loading message

    if (testResults && testResults.length > 0) {
      let lastTestName = '';

      testResults.forEach(result => {
        if (result.test !== lastTestName) {
          // Add a separator for each new test group
          const liTestName = document.createElement('li');
          liTestName.innerHTML = `<strong>Test:</strong> ${result.test}`;
          testResultsList.appendChild(liTestName);
          lastTestName = result.test;
        }

        const li = document.createElement('li');
        li.innerHTML = `
          <strong>Browser:</strong> ${result.browser} <br>
          <strong>Status:</strong> ${result.status} <br>
          <strong>Articles:</strong> ${result.articles !== undefined ? result.articles : 'N/A'} <br>
          <strong>Page Load Time:</strong> ${result.performance && result.performance.pageLoadTime !== undefined ? result.performance.pageLoadTime + ' ms' : 'N/A'} <br>
          <strong>Time to First Byte:</strong> ${result.performance && result.performance.timeToFirstByte !== undefined ? result.performance.timeToFirstByte + ' ms' : 'N/A'} <br>
        `;
        testResultsList.appendChild(li);
      });
    } else {
      testResultsList.textContent = 'No test results found.';
    }
  }

  // Function to draw the performance chart, excluding tests without load time or first byte data
  function drawPerformanceChart(testResults) {
    const ctx = document.getElementById('performanceChart').getContext('2d');

    // Filter out results that don't have valid performance data (page load and time to first byte)
    const filteredResults = testResults.filter(result => {
      const performance = result.performance;
      return performance && performance.pageLoadTime !== undefined && performance.timeToFirstByte !== undefined;
    });

    // Extract chart data only for tests with valid performance data
    const labels = filteredResults.map(result => `${result.test} (${result.browser})`);
    const pageLoadTimes = filteredResults.map(result => result.performance.pageLoadTime);
    const timeToFirstByte = filteredResults.map(result => result.performance.timeToFirstByte);

    if (labels.length === 0) {
      console.log('No valid performance data to display in chart.');
      return;
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Page Load Time (ms)',
            data: pageLoadTimes,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderWidth: 1
          },
          {
            label: 'Time to First Byte (ms)',
            data: timeToFirstByte,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderWidth: 1
          }
        ]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Fetch the test results and display them
  fetch('testResults.json')
    .then(response => response.json())
    .then(data => {
      // Display test results in the list
      displayTestResults(data);

      // Only draw the performance chart with tests that have valid performance data
      drawPerformanceChart(data);
    })
    .catch(error => {
      document.getElementById('testResultsLoading').textContent = 'Error loading test results.';
      console.error('Error fetching test results:', error);
    });
</script>
